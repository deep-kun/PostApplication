<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>Single Page Application</title>
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <!-- Optional theme -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">
</head>
<body>
    <div class="navbar navbar-inverse">
        <h1 style="color: aliceblue; ">Post app</h1>
        <div id="NoAuth" style="float: right;">
            <button onclick="show('login')" class="btn btn-primary">Log</button>
            <button onclick="show('register')" class="btn btn-primary">Register</button>
        </div>
        <div id="authed" style="display:none">
            <button onclick="show('compose')" class="btn btn-primary">Compose</button>
            <button onclick="singout()" class="btn btn-primary">Sing Out</button>
        </div>
    </div>

    <!-- reg form-->
    <div id="register" style="display:none">
        <h3>Register form</h3>
        <div class="form-group">
            <input id="regName" class="form-control" type="text" placeholder="Name">
            <input id="regUser" class="form-control" type="text" placeholder="Login">
            <input id="regPass" class="form-control" type="password" placeholder="Password">
            <button onclick="
var object = new Object();
object.Name = document.getElementById('regName').value;
object.Login = document.getElementById('regUser').value;
object.Password = document.getElementById('regPass').value;

document.getElementById('regName').value = '';
document.getElementById('regUser').value= '';
document.getElementById('regPass').value= '';

console.log(object);
HttpRequest('Auth/reg', 'post', object, 'register');
    "
                    class="btn btn-primary">
                Register
            </button>
        </div>
    </div>
    


<!-- log form-->
    <div id="login" style="display:block">
        <h3>Login form</h3>
        <div class="form-group">
            <input id="logUser" class="form-control" type="text" placeholder="Login">
            <input id="logPass" class="form-control" type="text" placeholder="Password">
            <button onclick="
var object = new Object();
object.Login = document.getElementById('logUser').value;
object.Password = document.getElementById('logPass').value;

document.getElementById('logUser').value = '';
document.getElementById('logPass').value = '';

    console.log(object);
HttpRequest('Auth/log', 'post', object, 'login');
"
                    class="btn btn-primary">
                Login
            </button>
        </div>
    </div>
    


<!-- compose form-->
    <div id="compose" style="display:none">
        <h3>Login form</h3>
        <div class="form-group">
            <input id="comUser" class="form-control" type="text" placeholder="reciver">
            <input id="comSubject" class="form-control" type="text" placeholder="Subject">
            <input id="comText" class="form-control" type="text" placeholder="body">
            <button onclick="
var object = new Object();
object.Receiver = document.getElementById('comUser').value;
object.Subject = document.getElementById('comSubject').value;
object.Body = document.getElementById('comText').value;

document.getElementById('comUser').value= '';
document.getElementById('comSubject').value = '';
document.getElementById('comText').value = '';



console.log(object);
HttpRequest('Mail/send', 'post', object, 'compose');
"
                    class="btn btn-primary">
                Send
            </button>
        </div>
    </div>
    


<!-- msg view-->
    <table id="myTable" style="width: 100%;">
        <tr>
            <th>Date</th>
            <th>Subject</th>
            <th>IsRead</th>
            <th>IsStared</th>
            <th>Author</th>
            <th>Read</th>
        </tr>
    </table>



    <!-- msg view-->
<div id="msgView" style="display: none">
    <button onclick="show('myTable');show('msgView'); load();" class="btn">Back to all mesages</button>
    <div id="Subject" class="panel panel-primary">Text</div>
    <div id="Date" class="panel panel-primary">Text</div>
    <div id="Author" class="panel panel-primary">Text</div>
    <div id="Body" class="panel panel-primary">Text</div>
</div>


<button onclick="load();">load</button>


    <script>
        function show(node) {
            if (node === null) {
                return;
            }
            var n = document.getElementById(node.toString());
            if (n.style.display === "none") {
                n.style.display = "block";
            } else {
                n.style.display = "none";
            }
        }

        function load() {
            console.log("load");
            var table = document.getElementById("myTable");
            var tableRows = table.getElementsByTagName('tr');
            var rowCount = tableRows.length;
            for (var x=rowCount-1; x>0; x--) {
                table.removeChild(tableRows[x]);
            }
            var Http = new XMLHttpRequest();
            var url = "http://localhost:51368/api/" + "Mail/";
            Http.open('get', url, true);
            Http.setRequestHeader('Content-Type', 'application/json');
            Http.send();

            Http.onload = () => {
                var json = JSON.parse(Http.responseText);
                for (var i = 0; i < json.length; i++) {
                    var row = table.insertRow(1);

                    var date = row.insertCell(0);   
                    var subject = row.insertCell(1);
                    var IsRead = row.insertCell(2);
                    var IsStared = row.insertCell(3);
                    var Author = row.insertCell(4);
                    var Link = row.insertCell(5);

                    date.innerHTML = json[i].Date;
                    subject.innerHTML = json[i].Date;
                    IsRead.innerHTML = json[i].IsRead;
                    IsStared.innerHTML = json[i].IsStared;
                    Author.innerHTML = json[i].Author;
                    Link.innerHTML = '<button class="btn btn-success" onClick="see(' + json[i].MessageId.toString() + ');">Read this</button>';
                }

                console.log(Http.responseText);
            }
        }

        function see(id) {
            console.log("see" + id);
            show('myTable');
            show('msgView');
            var Http = new XMLHttpRequest();
            var url = "http://localhost:51368/api/" + "Mail/";
            Http.open('get', url + id.toString(), true);
            Http.setRequestHeader('Content-Type', 'application/json');
            Http.send();

            Http.onload = () => {

                var json = JSON.parse(Http.responseText);
                document.getElementById('Subject').innerHTML = json.Subject;
                document.getElementById('Date').innerHTML = json.Date;
                document.getElementById('Author').innerHTML = json.Author;
                document.getElementById('Body').innerHTML = json.Body;
            }
        }

        function HttpRequest(controller, method, object, caller) {
            var Http = new XMLHttpRequest();
            var url = "http://localhost:51368/api/" + controller;
            Http.open(method, url, true);
            Http.setRequestHeader('Content-Type', 'application/json');
            Http.send(JSON.stringify(object));

            Http.onload = () => {
                if (Http.status == 400 || Http.status == 500) {
                    var m = JSON.parse(Http.responseText);
                    ErrorHappens(m.Message);
                    return null;
                }
                show(caller);
                if (caller.toString() === 'login' || caller.toString() === 'register' ) {
                    show('NoAuth');
                    show('authed');
                }
                return JSON.parse(Http.responseText);
            }
        }

        function singout() {
            var Http = new XMLHttpRequest();
            var url = "http://localhost:51368/api/auth/singout";
            Http.open('get', url, true);
            Http.setRequestHeader('Content-Type', 'application/json');
            Http.send();

            Http.onload = () => {
                console.log('sing out');
                show('myTable');
                show('NoAuth');
                show('authed');
                return JSON.parse(Http.responseText);
            }

        }

        function ErrorHappens(context) {
            alert(context.toString());
        }

        document.onload = ready();

        function ready() {
            var Http = new XMLHttpRequest();
            var url = "http://localhost:51368/api/" + "Auth/ami";
            Http.open('get', url, true);
            Http.setRequestHeader('Content-Type', 'application/json');
            Http.send();
            Http.onload = () => {
                console.log(Http.status);
                
                if (Http.status == 401 || Http.status == 500) {
                    var m = JSON.parse(Http.responseText);
                    ErrorHappens(m.Message);
                    return null;
                    }
                    show('NoAuth');
                show('authed');
                show('login');
                }
        }

    </script>
</body>
</html>
